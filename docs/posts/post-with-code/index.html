<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Zhiwei Zhang">
<meta name="dcterms.date" content="2025-01-17">

<title>From Data to Wine: Unlocking Efficiency in the Wine Industry Through Data Science – Data + Dollars</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Data + Dollars</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">From Data to Wine: Unlocking Efficiency in the Wine Industry Through Data Science</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">analysis</div>
                <div class="quarto-category">insight</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Zhiwei Zhang </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 17, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="wine.jpg" class="img-fluid figure-img"></p>
<figcaption>Source: https://www.pexels.com/photo/photo-of-wine-bottles-on-rack-2664149/</figcaption>
</figure>
</div>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>The wine industry has long relied on tradition, intuition, and craftsmanship. However, with the rise of machine learning and data science, this centuries-old industry is entering a new era. By analyzing data, winemakers and distributors can optimize production, ensure quality, and better cater to consumers.</p>
<p>In this blog, we’ll explore how machine learning techniques, such as supervised learning and regression models, are being used to enhance efficiency and drive innovation in the wine industry. Specifically, we’ll use the example of predicting wine color based on physiochemical properties, a project with wide-ranging implications for the industry.</p>
<p>Let’s embark on this journey to understand how data science transforms the wine industry and provides actionable insights for both producers and consumers.</p>
<hr>
</section>
<section id="the-role-of-machine-learning-in-wine-production" class="level1">
<h1>The Role of Machine Learning in Wine Production</h1>
<p>Machine learning is a powerful tool for making predictions and uncovering patterns in data. For example, consider the task of predicting wine color (red or white) based on chemical attributes like acidity, pH, and alcohol content. This application has several potential benefits:</p>
<ul>
<li><strong>Improving Inventory Management</strong>: Accurate predictions help wineries and retailers categorize and organize wines, ensuring proper storage and marketing.</li>
<li><strong>Enhancing Quality Control</strong>: Machine learning models can detect misclassified or mislabeled wines, reducing errors before products reach consumers.</li>
<li><strong>Streamlining Production Processes</strong>: Insights from data can guide winemakers in optimizing their recipes and processes, reducing costs and waste.</li>
</ul>
<hr>
</section>
<section id="recap-of-data-science-machine-learning-basics" class="level1">
<h1>Recap of Data Science &amp; Machine Learning Basics</h1>
<p>Before diving deeper into how machine learning is revolutionizing the wine industry, let’s take a moment to recap some basic concepts in data science and machine learning. This will help build a foundation for understanding the methods we’ll discuss later.</p>
<section id="what-is-supervised-learning" class="level2">
<h2 class="anchored" data-anchor-id="what-is-supervised-learning">What is Supervised Learning?</h2>
<p>Supervised learning is one of the most common types of machine learning. In this approach, the model learns from labeled data, which means each input (e.g., physiochemical properties of wine) is paired with a known output (e.g., wine color: red or white). The goal of supervised learning is to find a function that maps inputs to outputs as accurately as possible.</p>
<p>Imagine you’re a student learning to recognize different types of fruits. If someone shows you a banana and tells you it’s a banana, and then does the same for an apple, you’ll eventually learn to identify these fruits yourself. This is essentially supervised learning—the model (you) is trained on examples with labels (fruit types) to make predictions on unseen examples.</p>
<p>In the context of the wine industry, supervised learning can help predict wine characteristics, like color or quality, based on its chemical composition.</p>
</section>
<section id="what-is-a-regression-model" class="level2">
<h2 class="anchored" data-anchor-id="what-is-a-regression-model">What is a Regression Model?</h2>
<p>Regression is a type of supervised learning used for predicting continuous outcomes. Unlike classification (e.g., red or white wine), regression models predict numerical values. For example:</p>
<ul>
<li>Predicting the alcohol content of a wine based on its acidity and sugar levels.</li>
<li>Estimating the optimal harvest date based on weather patterns.</li>
</ul>
<p>Regression models try to fit a line (or curve) to the data that best represents the relationship between the inputs and outputs. A common example is linear regression, where the goal is to find a straight line that minimizes the difference between predicted and actual values. Suppose you’re trying to predict the price of a bottle of wine based on its age. The older the wine, the more expensive it typically is. Linear regression helps determine the exact relationship between age and price, allowing you to make predictions.</p>
<hr>
</section>
</section>
<section id="example-project-predicting-wine-color-using-physiochemical-properties" class="level1">
<h1>Example Project: Predicting Wine Color Using Physiochemical Properties</h1>
<section id="dataset-overview" class="level2">
<h2 class="anchored" data-anchor-id="dataset-overview">Dataset Overview</h2>
<p>For this project, the dataset comes from the UCI Machine Learning Repository （https://archive.ics.uci.edu/dataset/186/wine+quality）. It contains data from approximately 6,500 samples of red and white wines. Each sample includes 11 physiochemical properties, such as Fixed Acidity, Volatile Acidity, Citric Acid, Residual Sugar, Alcohol Content.</p>
<p>The target variable (the feature we want to predict) is wine color: red or white.</p>
<p>Before diving into the model training, let’s take a closer look at the data distribution for some key features.</p>
<p>Figure 1 reveals clear differences between red and white wines in key features. For example, red wines generally show higher volatile acidity (linked to tanginess) and citric acid levels, while white wines tend to have more residual sugar (contributing to sweetness) and free sulfur dioxide (used for preservation). Interestingly, alcohol content shows a slightly higher range for white wines, but red wines have lower pH (more acidic), which may influence color. While some features like quality and residual sugar show overlap between wine types, their interactions with other features improve the model’s ability to distinguish red from white wines.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="feature_densities_by_class.png" class="img-fluid figure-img"></p>
<figcaption>Figure 1: Wine feature distribution with different colors. Image by author.</figcaption>
</figure>
</div>
</section>
<section id="step-by-step-workflow" class="level2">
<h2 class="anchored" data-anchor-id="step-by-step-workflow">Step-by-Step Workflow</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="steps.jpg" class="img-fluid figure-img"></p>
<figcaption>Figure 2: Steps of Modeling. Image by author.</figcaption>
</figure>
</div>
<section id="step1-data-preprocessing" class="level3">
<h3 class="anchored" data-anchor-id="step1-data-preprocessing">Step1: Data Preprocessing</h3>
<ol type="1">
<li><strong>Data Cleaning</strong>: Removed duplicates and handled missing values. Ensured all features, like acidity and alcohol content, fell within realistic ranges.</li>
<li><strong>Feature Standardization</strong>: Standardized all features to have a mean of 0 and a standard deviation of 1. This prevents features with larger scales from dominating the model.</li>
<li><strong>Data Splitting</strong>: Split the dataset into 70% for training and 30% for testing to evaluate how the model performs on unseen data.</li>
</ol>
</section>
<section id="step-2-model-selection" class="level3">
<h3 class="anchored" data-anchor-id="step-2-model-selection">Step 2: Model Selection</h3>
<p>We used logistic regression, a simple yet effective supervised learning model, to predict wine color. Logistic regression works by estimating the probability of an event based on input features.</p>
<p><strong>Why logistic regression?</strong> 1. Easy to implement and understand. 2. Provides feature importance, helping us interpret which properties are most relevant for predictions. 3. Suitable for binary classification tasks like this one.</p>
</section>
<section id="step-3-model-training-and-evaluation" class="level3">
<h3 class="anchored" data-anchor-id="step-3-model-training-and-evaluation">Step 3: Model Training and Evaluation</h3>
<ol type="1">
<li><strong>Training the Model</strong>: The model was trained on the training set and fine-tuned using cross-validation, a technique to ensure it generalizes well to new data.</li>
<li><strong>Evaluation</strong>: Tested the model on the remaining 30% of the data, using metrics like accuracy, precision, and recall. These are all metrics to evaluate how good the model perform. The closer to 1, the better the model perform on new datas.</li>
</ol>
<p><strong>Results:</strong></p>
<ul>
<li>Test accuracy: <strong>99.1%</strong> of predictions were correct.</li>
<li>Precision and recall: Both exceeded <strong>98%</strong>, showing the model reliably distinguishes red and white wines.</li>
</ul>
<hr>
</section>
</section>
</section>
<section id="applications-in-the-wine-industry" class="level1">
<h1>Applications in the Wine Industry</h1>
<p>Beyond predicting wine color, machine learning can revolutionize other aspects of the wine industry:</p>
<ol type="1">
<li><strong>Optimizing Harvesting</strong>:
<ul>
<li>By analyzing weather patterns and soil data, machine learning models can predict the best time to harvest grapes for maximum quality.</li>
</ul></li>
<li><strong>Flavor Profiling</strong>:
<ul>
<li>Using consumer feedback and chemical analysis, data science can help identify flavor profiles that appeal to different markets.</li>
</ul></li>
<li><strong>Supply Chain Management</strong>:
<ul>
<li>Predictive models can optimize distribution routes and inventory levels, reducing costs and ensuring timely deliveries.</li>
</ul></li>
<li><strong>Personalized Recommendations</strong>:
<ul>
<li>Just as streaming services recommend shows, machine learning can suggest wines tailored to individual preferences.</li>
</ul></li>
</ol>
<hr>
</section>
<section id="challenges" class="level1">
<h1>Challenges</h1>
<p>While the opportunities are vast, adopting machine learning in the wine industry comes with challenges:</p>
<ul>
<li><strong>Data Quality</strong>: Inconsistent or incomplete data can hinder model performance.</li>
<li><strong>Interpretability</strong>: Winemakers may hesitate to trust “black-box” models that lack transparency.</li>
<li><strong>Integration</strong>: Combining traditional practices with data-driven methods requires a cultural shift.</li>
</ul>
<hr>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>The integration of data science into the wine industry marks an exciting chapter in its evolution. By leveraging machine learning, winemakers can optimize production, enhance quality, and cater to consumers more effectively.</p>
<p>As we’ve seen, data science doesn’t just provide answers—it opens new possibilities. The future of wine may still be rooted in tradition, but with the power of data, it’s becoming smarter and more efficient.</p>
<hr>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>